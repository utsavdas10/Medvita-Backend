<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
</head>
<body>
    <video id="video" width="10%" height="10%" autoplay></video>
    <img id="img" width="50%" height="50%">
    <script>
        const videoElement = document.getElementById('video');
        const img = document.getElementById('img');

        // Access webcam stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                videoElement.srcObject = stream;

                // Create a WebSocket connection
                const ws = new WebSocket('ws://127.0.0.1/ws');

                // When the connection is open
                ws.addEventListener('open', () => {
                    console.log('WebSocket connection established');
                });

                // When a new frame is available from the webcam
                videoElement.addEventListener('play', () => {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;

                    setInterval(() => {
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL('image/jpeg'); // Convert frame to base64
                        
                        const imageBlob = fetch(imageData).then(res => res.blob()); // base64 to blob
                        imageBlob.then(blob => ws.send(blob)); // Send the blob to the server
                    }, 100); // Adjust the interval as needed
                });
                ws.onmessage = function(event) {
                    console.log('Message from server ', event.data);

                    var arrayBuffer = new Uint8Array(event.data);
                    var blob = new Blob([arrayBuffer], { type: 'image/jpeg' });

                    // Create an object URL from the Blob
                    var url = URL.createObjectURL(blob);

                    // Set the source of the video element to the object URL
                    img.src = url;

                };
            })
            .catch((error) => {
                console.error('Error accessing webcam:', error);
            });

        
    </script>
</body>
</html>